```{r}
library(shiny)
library(dplyr)
library(plotly)
library(readr)
library(htmltools)

alz <- read_csv("alzheimers_prediction_dataset.csv", show_col_types = FALSE) %>%
  rename(Diagnosis = `Alzheimer’s Diagnosis`)
```

```{r}
ui <- fluidPage(
  theme = bslib::bs_theme(bootswatch = "flatly"),
  titlePanel("Alzheimer's Risk Factor Analysis Dashboard"),
  
  sidebarLayout(
    sidebarPanel(
      width = 3,
      tags$div(
        class = "filter-section",
        tags$h4(
          "Population Filters",
          style = "color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 10px;"),
        sliderInput(
          inputId = "ageRange",
          label   = "Age Range:",
          min     = floor(min(alz$Age, na.rm = TRUE)),
          max     = ceiling(max(alz$Age, na.rm = TRUE)),
          value   = c(50, 90)
        ),
        selectInput(
          inputId  = "genderFilter",
          label    = "Gender:",
          choices  = c("All", unique(alz$Gender)),
          selected = "All"
        ),
        selectInput(
          inputId  = "countryFilter",
          label    = "Country:",
          choices  = c("All", unique(alz$Country)),
          selected = "All"
        )
      ),
      
      tags$hr(),
      
      tags$div(
        class = "analysis-section",
        tags$h4(
          "Analysis Variables",
          style = "color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 10px;"
        ),
        
        selectInput(
          inputId  = "varChoice",
          label    = "Primary Risk Factor:",
          choices  = c(
            "Physical Activity Level", "Smoking Status", "Alcohol Consumption",
            "Diabetes", "Hypertension", "Cholesterol Level",
            "Family History of Alzheimer’s", "Genetic Risk Factor (APOE-ε4 allele)",
            "Stress Levels", "Depression Level", "Sleep Quality", "Dietary Habits",
            "Air Pollution Exposure", "Employment Status", "Marital Status",
            "Social Engagement Level", "Income Level", "Urban vs Rural Living",
            "Education Level", "BMI", "Cognitive Test Score"
          ),
          selected = "Physical Activity Level"
        )
      )
    ),
    
    mainPanel(
      width = 9,
      tags$div(
        style = "display: flex; flex-direction: column;",
        
        # Key Insights
        tags$div(
          class = "insights-panel",
          style = "padding: 15px; background-color: #f5f5f5; border-radius: 5px; margin-bottom: 20px;",
          tags$h3("Key Insights", style = "margin-top: 0; color: #2c3e50;"),
          uiOutput("keyInsights")
        ),
        
        # Charts
        tags$div(
          style = "display: flex; flex-wrap: wrap;",
          
          # Pie chart
          tags$div(
            style = "flex: 1; min-width: 300px; margin-right: 20px;",
            tags$div(
              style = "background-color: white; border-radius: 5px; padding: 15px; min-height: 520px;",
              tags$h4("Distribution in Alzheimer's Patients",
                      style = "color: #2c3e50; text-align: center;"),
              plotlyOutput("alzheimerPieChart", height = "550px")
            )
          ))
          )
        )
      )
  
)
```

```{r}
server <- function(input, output, session) {
  filtered_data <- reactive({
    alz %>%
      filter(
        Age >= input$ageRange[1],
        Age <= input$ageRange[2],
        (input$genderFilter  == "All" | Gender  == input$genderFilter),
        (input$countryFilter == "All" | Country == input$countryFilter)
      ) %>%
      mutate(
        `Education Level (Binned)` = cut(
          `Education Level`,
          breaks = c(-Inf, 4, 9, 14, Inf),
          labels = c("Low", "Medium", "High", "Very High"),
          right  = TRUE
        ),
        `BMI (Binned)` = cut(
          BMI,
          breaks = c(-Inf, 24.9, 29.9, Inf),
          labels = c("Normal", "Overweight", "Obese"),
          right  = TRUE
        ),
        `Cognitive Score (Binned)` = cut(
          `Cognitive Test Score`,
          breaks = c(-Inf, 46, 64, 82, Inf),
          labels = c("Low", "Medium", "High", "Very High"),
          right  = TRUE
        )
      )
  })
  
  summary_data <- reactive({
    df  <- filtered_data()
    var <- input$varChoice
    
    var_mapped <- dplyr::case_when(
      var == "Education Level"      ~ "Education Level (Binned)",
      var == "BMI"                  ~ "BMI (Binned)",
      var == "Cognitive Test Score" ~ "Cognitive Score (Binned)",
      TRUE ~ var
    )
    
    result <- df %>%
      group_by(Diagnosis, .data[[var_mapped]]) %>%
      summarise(Count = n(), .groups = "drop") %>%
      filter(!is.na(.data[[var_mapped]])) %>%
      group_by(Diagnosis) %>%
      mutate(
        Total      = sum(Count),
        Percentage = round(Count / Total * 100, 1)
      ) %>%
      ungroup()
    
    comparison <- result %>%
      select(Diagnosis, !!as.name(var_mapped), Percentage) %>%
      tidyr::pivot_wider(names_from = Diagnosis, values_from = Percentage) %>%
      mutate(Difference = Yes - No) %>%
      arrange(desc(abs(Difference)))
    
    yes_total <- sum(df$Diagnosis == "Yes", na.rm = TRUE)
    no_total  <- sum(df$Diagnosis == "No",  na.rm = TRUE)
    
    list(
      detail      = result,
      comparison  = comparison,
      yes_total   = yes_total,
      no_total    = no_total,
      yes_percent = round(yes_total / (yes_total + no_total) * 100, 1)
    )
  })
  
  overall_rate_static <- round(
  sum(alz$Diagnosis == "Yes", na.rm = TRUE) / nrow(alz) * 100, 1
)
  
  # Key Insights panels
 output$keyInsights <- renderUI({
   data <- summary_data()
   var  <- input$varChoice
   overall_rate <- overall_rate_static # Use pre-calculated overall rate

   # Check if data is available for insights
   if (nrow(data$comparison) == 0 || is.null(data$comparison) || all(is.na(data$comparison))) {
      # Display counts and percentage if available, otherwise message
      total_filtered = data$yes_total + data$no_total
      content <- if (total_filtered > 0) {
          tags$div(
            tags$div( # Top row structure even if insights are missing
               style = "display: flex; justify-content: space-between; margin-bottom: 15px;",
               tags$div(
                 style = "flex: 1; text-align: center; background-color: #e8f4f8; padding: 10px; border-radius: 5px; margin-right: 10px;",
                 tags$h4(data$yes_total, style = "margin: 0; color: #2980b9;"),
                 tags$p("Alzheimer's Patients", style = "margin: 0;")
               ),
               tags$div(
                 style = "flex: 1; text-align: center; background-color: #f8f4e8; padding: 10px; border-radius: 5px;",
                 tags$h4(paste0(data$yes_percent, "%"), style = "margin: 0; color: #d35400;"),
                 tags$p("of Selected Population", style = "margin: 0;")
               )
            ),
            tags$p("Insufficient data for the selected variable and filters to generate detailed insights.", style="text-align: center; font-style: italic; margin-top: 15px;")
         )
      } else {
         tags$p("No individuals found matching the selected filters.", style="text-align: center; font-style: italic; margin-top: 15px;")
      }
      return(content)
   }

   top_diff <- data$comparison[1, ]

   # Map variable name again for indexing, ensure column exists
   var_mapped <- dplyr::case_when(
       var == "Education Level"       & "Education Level (Binned)" %in% names(data$comparison) ~ "Education Level (Binned)",
       var == "BMI"                   & "BMI (Binned)" %in% names(data$comparison) ~ "BMI (Binned)",
       var == "Cognitive Test Score"  & "Cognitive Score (Binned)" %in% names(data$comparison) ~ "Cognitive Score (Binned)",
       TRUE ~ var
   )

   # Safely get the value from the top difference row using the mapped variable name
   raw_value <- top_diff[[var_mapped]]

   # Format the factor value for display
   factor_value <- if (is.numeric(raw_value)) {
     paste0("level ", round(raw_value, 1)) # Use level for numeric/binned continuous
   } else {
     as.character(raw_value) # Use value for categorical
   }

   # Safely get percentages and difference, defaulting to 0 if NA or non-finite
   yes_percent <- ifelse(is.na(top_diff[["Yes"]]) | !is.finite(top_diff[["Yes"]]), 0, top_diff[["Yes"]])
   no_percent  <- ifelse(is.na(top_diff[["No"]]) | !is.finite(top_diff[["No"]]), 0, top_diff[["No"]])
   difference  <- ifelse(is.na(top_diff[["Difference"]]) | !is.finite(top_diff[["Difference"]]), 0, top_diff[["Difference"]])

   direction   <- ifelse(difference > 0, "higher", "lower")
   rel_diff    <- round(abs(difference), 1)

   # Format percentages for display
   yes_percent_fmt <- paste0(round(yes_percent, 1), "%")
   no_percent_fmt  <- paste0(round(no_percent, 1), "%")

   # Construct Key Finding sentence dynamically
   key_finding_text <- if(rel_diff > 0) {
       paste0(
           "For the variable '", var, "', the group '", factor_value,
           "' shows the largest percentage point difference. This group makes up ",
           yes_percent_fmt, " of Alzheimer's patients compared to ", no_percent_fmt,
           " of non-Alzheimer's patients in this selection (a ", rel_diff, " point difference)."
        )
   } else {
      paste0(
          "For the variable '", var, "', no significant percentage point difference was observed ",
          "between Alzheimer's and non-Alzheimer's patients for any category within the selected population."
      )
   }


   # Construct Demographic label based on filters
   demo_components <- c()
   if (input$genderFilter != "All") demo_components <- c(demo_components, input$genderFilter)
   if (input$countryFilter != "All") demo_components <- c(demo_components, input$countryFilter)
   # Always include age range
   age_range_str <- paste0("age ", input$ageRange[1], "–", input$ageRange[2])
   demo_components <- c(demo_components, age_range_str)
   demo_label <- paste(demo_components, collapse = ", ")

   # Calculate comparison to overall rate
   current_rate   <- data$yes_percent # Rate within the filtered group
   demo_change    <- round(current_rate - overall_rate, 1)
   demo_direction <- ifelse(demo_change > 0, "higher than", ifelse(demo_change < 0, "lower than", "the same as"))
   demo_abs       <- abs(demo_change)

   # Construct Demographic Insight sentence dynamically
   demographic_insight_text <- paste0(
       "The selected group (", demo_label, ") has an Alzheimer's diagnosis rate of ",
       current_rate, "%. This is ", demo_abs, "% points ", demo_direction,
       " the overall population's rate of ", overall_rate, "%."
   )


   # Render the UI using the original structure but with dynamic text
   tags$div(
     # Top row: Counts and Percentage
     tags$div(
       style = "display: flex; justify-content: space-between; margin-bottom: 15px;",
       tags$div(
         style = "flex: 1; text-align: center; background-color: #e8f4f8; padding: 10px; border-radius: 5px; margin-right: 10px;",
         tags$h4(data$yes_total, style = "margin: 0; color: #2980b9;"),
         tags$p("Alzheimer's Patients", style = "margin: 0;")
       ),
       tags$div(
         style = "flex: 1; text-align: center; background-color: #f8f4e8; padding: 10px; border-radius: 5px;",
         tags$h4(paste0(current_rate, "%"), style = "margin: 0; color: #d35400;"),
         tags$p("of Selected Population", style = "margin: 0;")
       )
     ),
     # Bottom row: Insight Boxes
     tags$div(
       style = "display: flex; gap: 10px; margin-bottom: 10px;",
       tags$div(
         style = "flex: 1; background-color: white; padding: 15px; border-left: 4px solid #3498db;",
         tags$p(
           tags$strong("Key Finding:"), br(), # Added line break for readability
           key_finding_text # Use the new dynamic text
         )
       ),
       tags$div(
         style = "flex: 1; background-color: white; padding: 15px; border-left: 4px solid #2ecc71;",
         tags$p(
           tags$strong("Demographic Insight:"), br(), # Added line break
           demographic_insight_text # Use the new dynamic text
         )
       )
     )
   ) # End main container div
 }) # End renderUI


  # Pie chart
output$alzheimerPieChart <- renderPlotly({
  var <- input$varChoice
  
  var_mapped <- dplyr::case_when(
    var == "Education Level" ~ "Education Level (Binned)",
    var == "BMI" ~ "BMI (Binned)",
    var == "Cognitive Test Score" ~ "Cognitive Score (Binned)",
    TRUE ~ var)
  
  df <- filtered_data() %>%
        filter(!is.na(.data[[var_mapped]]))
  
  yes_df <- df %>%
    filter(Diagnosis == "Yes") %>%
    group_by(level = .data[[var_mapped]]) %>%   
    summarise(n = n(), .groups = "drop")
  no_df <- df %>%
    filter(Diagnosis == "No") %>%
    group_by(level = .data[[var_mapped]]) %>% 
    summarise(n = n(), .groups = "drop")
  
  yes_cols <- colorRampPalette(c("#1f77b4", "#aec7e8"))(nrow(yes_df))
  no_cols  <- colorRampPalette(c("#e74c3c", "#f5b7b1"))(nrow(no_df))
  
  plot_ly() %>%
    # OUTER ring : Yes 
    add_pie(
      data       = yes_df,
      labels     = ~level,
      values     = ~n,
      name       = "Alzheimer's Yes",
      marker     = list(colors = yes_cols,
                        line   = list(color = "#FFFFFF", width = 1)),
      textinfo     = "label+percent+value",
      texttemplate = "%{label} (%{value})<br>%{percent}",
      textposition = "auto",
      hoverinfo  = "label+percent+value",
      domain     = list(x = c(0, 1), y = c(0, 1)),
      hole       = 0.6,
      sort       = FALSE,
      direction  = "clockwise",
      textfont   = list(size = 18, color = 'black', family = 'Arial', weight = 'bold'),
      outsidetextfont = list(size = 18, color = 'black', family = 'Arial', weight = 'bold')
    ) %>%
    # INNER ring : No
    add_pie(
      data       = no_df,
      labels     = ~level,
      values     = ~n,
      name       = "Alzheimer's No",
      marker     = list(colors = no_cols,
                        line   = list(color = "#FFFFFF", width = 1)),
      textinfo     = "label+percent+value",
      texttemplate = "%{label} (%{value})<br>%{percent}",
      textposition   = "inside",
      insidetextfont = list(size = 16, color = 'black', family = 'Arial', weight = 'bold'),
      hoverinfo  = "label+percent+value",
      domain     = list(x = c(0.23,0.77), y = c(0.23,0.77)),
      hole       = 0.3,    
      sort       = FALSE,
      direction  = "clockwise",
      showlegend = FALSE
    ) %>%
    layout(
      title = list(
        text = paste(var, "Distribution (Outer: Alzheimer's, Inner: Non-Alzheimer's)"),
        font = list(size = 16, family = 'Arial', weight = 'bold')
      ),
      showlegend = TRUE,
      legend = list(orientation = "h", x = 0.5, y = -0.05, xanchor = "center",
                   font = list(size = 15, family = 'Arial', weight = 'bold')),
      margin = list(t = 50, b = 50, l = 0, r = 0),
      uniformtext = list(minsize = 16, mode = 'show')
    )
  })}

shinyApp(ui, server)
```